name: Commit Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Cache the omni-dev binary on main branch for PR cache hits
  cache-omni-dev:
    name: Cache omni-dev
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/cache@v4
        id: cache-omni-dev
        with:
          path: ~/.cargo/bin/omni-dev
          key: omni-dev-${{ runner.os }}-0.12.0

      - uses: dtolnay/rust-toolchain@stable
        if: steps.cache-omni-dev.outputs.cache-hit != 'true'

      - name: Install omni-dev
        if: steps.cache-omni-dev.outputs.cache-hit != 'true'
        run: cargo install omni-dev --version 0.12.0

  check-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: action-works/omni-dev-commit-check@v1
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          verbose: true
          version: "0.12.0"
